<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Invest AI – Rapport dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      padding: 1.5rem 2rem;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    main {
      max-width: 1100px;
      margin: 1.5rem auto 3rem;
      padding: 0 1rem;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    .meta {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }
    button {
      background: #38bdf8;
      color: #0f172a;
      border: none;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button:hover {
      background: #0ea5e9;
    }
    #rapport-text {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.55rem 0.45rem;
      text-align: left;
    }
    th {
      border-bottom: 1px solid #374151;
      color: #9ca3af;
      font-weight: 500;
    }
    tr:nth-child(even) {
      background: #020617;
    }
    tr:nth-child(odd) {
      background: #020617;
    }
    .score-pill {
      display: inline-block;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .risk-low {
      background: rgba(34,197,94,0.15);
      color: #4ade80;
    }
    .risk-medium {
      background: rgba(250,204,21,0.15);
      color: #facc15;
    }
    .risk-high {
      background: rgba(248,113,113,0.15);
      color: #f87171;
    }
    .potentie {
      background: rgba(59,130,246,0.15);
      color: #60a5fa;
    }
    .badge {
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #1f2937;
      margin-right: 0.25rem;
      color: #9ca3af;
    }
    #status {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 0.5rem;
    }
    .error {
      color: #fca5a5;
    }
    @media (max-width: 700px) {
      header {
        padding: 1rem 1.25rem;
      }
      .card {
        padding: 1rem 1.1rem;
      }
      table {
        font-size: 0.8rem;
      }
      th, td {
        padding: 0.4rem 0.3rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Invest AI – Maandrapport</h1>
  </header>
  <main>
    <div class="card">
      <h2>Laatste rapport</h2>
      <div class="meta" id="meta-info">Nog geen data geladen.</div>
      <button id="refresh-btn">Ververs rapport</button>
      <div id="status"></div>
    </div>

    <div class="card">
  <h2>Laatste rapport</h2>
  <div class="meta" id="meta-info">Nog geen data geladen.</div>
  <button id="refresh-btn">Ververs rapport</button>
  <button id="generate-btn" style="margin-left:0.5rem;">Genereer nieuw rapport</button>
  <div id="status"></div>
</div>

    </div>

    <div class="card">
      <h2>Volledige tekst</h2>
      <div id="rapport-text">Nog geen rapport geladen.</div>
    </div>
  </main>

  <script>
    // ⬇️ VUL HIER JE BACKEND URL IN (ZONDER SLASH OP HET EINDE)
    const BACKEND_URL = "https://ai-assistent-backend-g25p.onrender.com";

    const refreshBtn = document.getElementById("refresh-btn");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta-info");
    const shortlistContainer = document.getElementById("shortlist-container");
    const rapportTextEl = document.getElementById("rapport-text");
    const generateBtn = document.getElementById("generate-btn");

    function riskClass(score) {
      if (score <= 3) return "risk-low";
      if (score <= 6) return "risk-medium";
      return "risk-high";
    }

    async function loadLatestReport() {
      statusEl.textContent = "Laden...";
      statusEl.classList.remove("error");

      try {
        const res = await fetch(BACKEND_URL + "/reports/latest");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        if (data.status !== "ok" || !data.report) {
          metaEl.textContent = "Nog geen rapport gevonden in de database.";
          shortlistContainer.innerHTML = "<div class='meta'>Geen shortlist beschikbaar.</div>";
          rapportTextEl.textContent = "Nog geen rapport beschikbaar.";
          statusEl.textContent = "";
          return;
        }
async function generateNewReport() {
  statusEl.textContent = "Nieuw rapport genereren...";
  statusEl.classList.remove("error");

  try {
    const res = await fetch(BACKEND_URL + "/shortlist-report-demo-save");
    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }
    const data = await res.json();
    if (data.status !== "ok") {
      throw new Error(data.error || "Onbekende fout bij opslaan van rapport.");
    }

    statusEl.textContent = "Nieuw rapport gegenereerd en opgeslagen. Rapport wordt opnieuw geladen...";
    // Na succesvol opslaan: opnieuw het laatste rapport ophalen
    await loadLatestReport();
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Fout bij genereren van nieuw rapport.";
    statusEl.classList.add("error");
  }
}

        const report = data.report;
        const year = report.year;
        const month = report.month;
        const createdAt = report.created_at;
        const shortlist = report.shortlist_json || [];
        const tekst = report.report_text || "";

        metaEl.textContent = `Maand: ${month}-${year} • Aantal aandelen in shortlist: ${shortlist.length}`;

        // Shortlist tabel
        if (!shortlist.length) {
          shortlistContainer.innerHTML = "<div class='meta'>Shortlist is leeg.</div>";
        } else {
          let html = "<table><thead><tr>";
          html += "<th>Symbool</th><th>Naam</th><th>Land</th><th>Beurs</th><th>Sector</th><th>Risico</th><th>Potentie</th>";
          html += "</tr></thead><tbody>";

          for (const item of shortlist) {
            const r = item.risico_score;
            const p = item.potentie_score;
            const rc = riskClass(r);
            html += "<tr>";
            html += `<td><span class="badge">${item.symbol}</span></td>`;
            html += `<td>${item.name || ""}</td>`;
            html += `<td>${item.country || ""}</td>`;
            html += `<td>${item.exchange || ""}</td>`;
            html += `<td>${item.sector || ""}</td>`;
            html += `<td><span class="score-pill ${rc}">${r}/10</span></td>`;
            html += `<td><span class="score-pill potentie">${p}/100</span></td>`;
            html += "</tr>";
          }

          html += "</tbody></table>";
          shortlistContainer.innerHTML = html;
        }

        // Rapporttekst
        rapportTextEl.textContent = tekst;
        statusEl.textContent = "Laatste rapport succesvol geladen.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Fout bij laden van rapport.";
        statusEl.classList.add("error");
      }
    }

    refreshBtn.addEventListener("click", loadLatestReport);

    refreshBtn.addEventListener("click", loadLatestReport);
generateBtn.addEventListener("click", generateNewReport);

// Automatisch 1x bij laden van de pagina
loadLatestReport();

  </script>
</body>
</html>
